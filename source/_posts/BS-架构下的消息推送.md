---
title: BS 架构下的消息推送
date: 2019-07-29 15:09:16
categories: 
- Html
tags: 
- 推送
---
B/S 架构系统基本都使用HTTP 协议通信

>所以首先来看看HTTP协议的特点：
>
>* 列表内容
>* 无状态性；
>* 通过Internet发送请求消息和响应消息；
>* 使用端口接收和发送消息，默认为80端口；但是底层还是使用Socket完成。

HTTP协议决定了服务器与客户端之间的连接方式，无法直接实现消息推送。 

<!-- more -->

### 解决方案

#### 1. 轮询：

客户端定时向服务器发送Ajax请求，服务器接到请求后马上返回响应信息，并关闭连接。

>什么是 AJAX ？
>
>AJAX = 异步 JavaScript 和 XML。
AJAX 不是新的编程语言，而是一种使用现有标准的新方法，一种用于创建快速动态网页的技术。
通过在后台与服务器进行少量数据交换，AJAX 可以使网页实现异步更新。这意味着可以在不重新加载整个网页的情况下，对网页的某部分进行更新。传统的网页（不使用AJAX）如果需要更新内容，必需重载整个网页面。有很多使用AJAX的应用程序案例：新浪微博、Google地图  等。

* **优点**：后端程序编写比较容易 
* **缺点**：请求中大半是无用的，浪费带宽和服务器资源 
* **实例**：适用于小型应用

#### 2. 长轮询：

客户端向服务器发送Ajax请求，服务器接到请求后Hold住连接，直到有新消息才返回响应信息，并关闭连接；客户端处理完响应信息后再向服务器发送新的请求。

* **优点**：在无消息的情况下不会频繁的请求，耗费的资源少 
* **缺点**：服务器Hold住连接会消耗资源，返回数据顺序无法保证，难于管理和维护 
* **实例**：WebQQ、Hi网页版、FaceBook IM等

{% asset_img 01.png %}

#### 3. 长连接：

在页面中嵌入一个隐藏的jframe，将这个隐藏的iframe的src属性设置为对一个长连接的请求或者采用XRH请求，服务器端就能源源不断地往客户端输入数据。

* **优点**：消息即时到达，不发无用的请求；管理起来也相对方便 
* **缺点**：服务器维护一个长连接会增加开销 
* **实例**：Gmail聊天

{% asset_img 02.png %}

#### 4. Flash Socket：

在页面中嵌入一个使用了Socket类的Flash程序，JavaScript通过调用此Flash程序提供的Socket接口与服务器端的Socket接口进行通信，JavaScript在收到服务器端传送的信息后控制页面的显示。

* **优点**：实现真正的即时通信，而不是伪即时 
* **缺点**：客户端必须安装Flash插件；非HTTP协议，无法自动穿越防火墙 
* ****实例****：网络互动游戏

#### 5. WebSocket：

WebSocket 是 HTML5 开始提供的一种在单个 TCP 连接上进行全双工通讯的协议。

WebSocket 使得客户端和服务器之间的数据交换变得更加简单，允许服务端主动向客户端推送数据。在 WebSocket API 中，浏览器和服务器只需要完成一次握手，两者之间就直接可以创建持久性的长连接，并进行双向实时数据传输。

* **优点**：事件驱动；异步；使用WS或者WSS协议的客户端Socket；能够实现真正意义上的推送功能，更好的节省服务器资源和带宽 
* **缺点**：少部分浏览器不支持，不同浏览器支持的程度和方式都不同

### 了解 WebSocket

WebSocket 协议本质上是一个基于 TCP 的协议。

为了建立一个 WebSocket 连接，客户端浏览器首先要向服务器发起一个 HTTP 请求（**websocket握手需要借助于http协议，建立连接后通信过程使用websocket协议**），这个请求和通常的 HTTP 请求不同，包含了一些附加头信息，其中附加头信息"Upgrade: WebSocket"表明这是一个申请协议升级的 HTTP 请求，服务器端解析这些附加的头信息然后产生应答信息返回给客户端，客户端和服务器端的 WebSocket 连接就建立起来了，双方就可以通过这个连接通道自由的传递信息，并且这个连接会持续存在直到客户端或者服务器端的某一方主动的关闭连接。

{% asset_img 03.png %}

Websocket 使用 ws 或 wss 的统一资源标志符，类似于 HTTPS，其中 wss 表示在 TLS 之上的 Websocket。如：

```
ws://example.com/wsapi
wss://secure.example.com/
```
Websocket 使用和 HTTP 相同的 TCP 端口，可以绕过大多数防火墙的限制。默认情况下，Websocket 协议使用 80 端口；运行在 TLS 之上时，默认使用 443 端口。

当获取到 Web Socket 连接后，可以通过 **send()** 方法来向服务器发送数据，并通过 **onmessage** 事件来接收服务器返回的数据。

下面 API 用于创建 WebSocket 对象。

```
/**
 * 创建 WebSocket 对象
 * url：指定连接的 URL
 * protocol:是可选的，指定了可接受的子协议。
 */
var Socket = new WebSocket(url, [protocol] );
```

#### websocket 与 socket 的区别

软件通信有七层结构，下三层结构偏向与数据通信，上三层更偏向于数据处理，中间的传输层则是连接上三层与下三层之间的桥梁，每一层都做不同的工作，上层协议依赖与下层协议。

基于这个通信结构的概念
，Socket 其实并不是一个协议，是为了便于程序员进行网络编程而产生的，是应用层与 TCP/IP 协议族通信的中间软件抽象层，是一组接口。当两台主机通信时，让 Socket 去组织数据，以符合指定的协议。TCP 连接则更依靠于底层的 IP 协议，IP 协议的连接则依赖于链路层等更低层次。

websocket 是 html5 规范中的一个部分，它借鉴了 socket 这种思想，为 web 应用程序客户端和服务端之间（注意是客户端服务端）提供了一种全双工通信机制。同时，它又是一种新的应用层协议，websocket 协议是为了提供 web 应用程序和服务端全双工通信而专门制定的一种应用层协议。

**总的来说：Socket 是传输控制层接口封装，WebSocket 是应用层协议。**

